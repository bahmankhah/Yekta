# افزونه وردپرس یکتا

این افزونه امکان اتصال سامانه Single Sign-On (SSO) یکتا به وردپرس را فراهم می‌کند. پس از فعال‌سازی می‌توانید تنظیمات سرویس را در بخش «تنظیمات SSO» انجام دهید.

## نصب

1. پوشه افزونه را در مسیر `wp-content/plugins/sso-wp` کپی کنید به طوری که فایل `sso-wp.php` مستقیماً داخل آن قرار گیرد.
2. (اختیاری) برای راه‌اندازی محیط تست محلی می‌توانید از Docker استفاده کنید:
   ```bash
   docker compose up
   ```
3. سپس افزونه **یکتا** را از بخش **Plugins** فعال کنید.

## تنظیمات

در منوی مدیریت وردپرس صفحه‌ای با عنوان «تنظیمات SSO» افزوده می‌شود. فیلدهای زیر را بر اساس اطلاعات سرویس دهنده پر کنید:

1. شناسه کلاینت
2. آدرس ورود
3. آدرس اعتبارسنجی
4. آدرس دریافت توکن
5. کلید مخفی
6. آدرس بازگشت پس از ورود
7. آدرس خروج
8. کلید عمومی
9. آدرس اطلاعات کاربر

با ذخیره تنظیمات مقادیر در وردپرس ذخیره می‌شوند.

## مدیریت کاربران

صفحه دیگری با عنوان «کاربران SSO» در منو ایجاد شده است. در این صفحه تمام کاربرانی که دارای فیلد `sso_global_id` هستند با صفحه‌بندی بیست‌تایی نمایش داده می‌شوند. بالای صفحه آمار امروز شامل تعداد ورودها و کاربران جدید مشاهده می‌شود.

با کلیک روی دکمه «نمایش اطلاعات» مقابل هر کاربر، جزئیات تکمیلی کاربر از آدرس `User Info URL` خوانده شده و در یک پنجره کوچک نمایش داده می‌شود.

## ثبت رویدادها

هنگام فعال‌سازی افزونه، جدولی با نام `yekta_audit` در پایگاه داده ساخته می‌شود که شامل ستون‌های `id`، `user_id`، `type`، `created_at` و `params` است. ورود و ایجاد کاربران در این جدول ثبت می‌شود و برای نمایش آمار در صفحه کاربران استفاده می‌شود.

## تغییر آداپتور

پیکربندی نگهدارنده ورود در فایل `src/configs/adapters.php` قرار دارد. سه روش `token`، `password` و `secret` وجود دارد که می‌توانید مقدار پیش‌فرض را تغییر دهید.

```php
return [
    'auth' => [
        'default' => 'sso',
        'contexts' => [
            'token' => [
                'context'       => Kernel\Auth\Guards\TokenSSOGuard::class,
                'login_url'     => get_option('yekta_sso_token_guard_login_url'),
                'client_id'     => get_option('yekta_sso_token_guard_client_id'),
                'validate_url'  => get_option('yekta_sso_token_guard_validate_url'),
                'redirect_url'  => get_option('yekta_sso_token_guard_redirect_url'),
                'public_key'    => get_option('yekta_sso_token_guard_public_key'),
            ]
        ]
    ],
];
```

در صورت نیاز می‌توانید کانتکست جدیدی افزوده و مقدار `default` را تغییر دهید.
